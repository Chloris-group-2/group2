---
title: "Chloris"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r}
library(rgdal)
library(raster)
library(RPostgres)


conn <- dbConnect(Postgres(), host = "bu-rstudio-connect.bu.edu",
                  user = "chloris", password = "msspfall22",
                  dbname = "chloris", sslmode="require") # SSL needed!
query <- "SELECT path, row, date, band, filename, count(*) FROM landsat GROUP BY path, row, date, band, filename LIMIT 10"
qdf <- dbGetQuery(conn, query)
dbDisconnect(conn)
qdf
conninfo <- "PG:host=bu-rstudio-connect.bu.edu user=chloris dbname=chloris password=msspfall22 table=landsat mode=2 where='date=\\'2021-10-17\\' AND band=\\'4\\''"
GDALinfo(conninfo)


getrcl = function(qa_array){
  cloud_value = c(2800, 2804, 2808, 2812, 6896, 6900, 6904, 6908)
  cloudshadow_value = c(2976, 2980, 2984, 2988, 3008, 3012, 3016, 3020, 7072, 7076, 7080, 7084, 7104, 7108, 7112, 7116)
  snowice_value = c(3744, 3748, 3752, 3756, 3776, 3780, 3784, 3788, 7840, 7844, 7848, 7852, 7872, 7876, 7880, 7884)
  cirrus_value = c(6816, 6820, 6824, 6828, 6848, 6852, 6856, 6860, 6896, 6900, 6904, 6908, 7072, 7076, 7080, 7084, 7104, 7108, 7112, 7116, 7840, 7844, 7848, 7852, 7872, 7876, 7880, 7884)
  rclValue = c()
  if (qa_array[1]){
    rclValue = c(rclValue, cloud_value)
  }
  if (qa_array[2]){
    rclValue = c(rclValue, cloudshadow_value)
  }
  if (qa_array[3]){
    rclValue = c(rclValue, snowice_value)
  }
  if (qa_array[4]){
    rclValue = c(rclValue, cirrus_value)
  }
  if (length(rclValue) == 0){
    rclValue = 3
  } else {
    rclValue = unique(rclValue)
  }
   rcl = cbind(rclValue, rep(3, length(rclValue)))
  return(rcl)
}

getMask = function(getDate, getBand, qa_array){
  tmp_con = paste("PG:host=bu-rstudio-connect.bu.edu user=chloris dbname=chloris password=msspfall22 table=landsat mode=2 where='date=\\'", getDate, "\\' AND band=\\'", getBand, "\\''", sep = "")
  tmp_con_QA = paste("PG:host=bu-rstudio-connect.bu.edu user=chloris dbname=chloris password=msspfall22 table=landsat mode=2 where='date=\\'", getDate, "\\' AND band=\\'QA\\''", sep = "")
  r <- raster(readGDAL(tmp_con))
  r_QA <- raster(readGDAL(tmp_con_QA))
  rcl = getrcl(qa_array)
  r_mask = reclassify(r_QA, rcl)
  #maskValue = c(2720, 2724)
  r_mask =  mask(r, r_mask, maskvalue = 3, updatvalue = NA, inverse = FALSE)
  plot(r_mask)
}
```


